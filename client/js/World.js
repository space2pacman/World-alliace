let map = {
	size: {
		width: 20,
		height: 20
	},
	surfaces: [
		[113,139,139,139,139,139,139,139,139,139,139,139,139,139,139,139,139,139,139,114],
		[127,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,125],
		[127,116,105,107,110,111,112,116,116,116,116,116,116,116,116,116,116,116,116,125],
		[127,116,120,122,125,126,127,116,116,116,116,116,116,116,116,116,116,116,116,125],
		[127,116,120,122,138,139,140,116,116,116,116,116,116,116,116,116,116,116,116,125],
		[127,116,120,122,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,125],
		[127,116,120,122,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,125],
		[127,116,135,137,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,125],
		[127,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,125],
		[127,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,125],
		[127,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,125],
		[127,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,125],
		[127,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,125],
		[127,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,125],
		[127,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,125],
		[127,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,125],
		[127,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,125],
		[127,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,125],
		[127,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,125],
		[128,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,129]
	],
	trees: [
		[200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200],
		[200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200],
		[200,200,200,200,200,200,200,201,203,212,208,200,200,200,200,200,200,200,200,200],
		[200,200,200,200,200,200,200,200,213,218,217,200,200,200,200,200,200,200,200,200],
		[200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200],
		[200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200],
		[200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200],
		[200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200],
		[200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200],
		[200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200],
		[200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200],
		[200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200],
		[200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200],
		[200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200],
		[200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200],
		[200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200],
		[200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200],
		[200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200],
		[200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200],
		[200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200]
	],
	buildings: [
		[300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300],
		[300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300],
		[300,300,300,300,300,300,300,300,300,300,208,300,300,300,300,300,300,300,300,300],
		[300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300],
		[300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300],
		[300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300],
		[300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300],
		[300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300],
		[300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300],
		[300,300,300,300,300,300,306,306,300,300,300,300,300,300,300,300,300,300,300,300],
		[300,300,300,300,300,300,308,309,300,300,300,300,300,300,300,300,300,300,300,300],
		[300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300],
		[300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300],
		[300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300],
		[300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300],
		[300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300],
		[300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300],
		[300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300],
		[300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300],
		[300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300]
	],
	roofs: [
		[400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400],
		[400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400],
		[400,400,400,400,400,400,400,400,400,400,208,400,400,400,400,400,400,400,400,400],
		[400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400],
		[400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400],
		[400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400],
		[400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400],
		[400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400],
		[400,400,400,400,400,400,410,411,400,400,400,400,400,400,400,400,400,400,400,400],
		[400,400,400,400,400,400,405,406,400,400,400,400,400,400,400,400,400,400,400,400],
		[400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400],
		[400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400],
		[400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400],
		[400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400],
		[400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400],
		[400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400],
		[400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400],
		[400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400],
		[400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400],
		[400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400]
	],
	misc: [
		[500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500],
		[500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500],
		[500,500,500,500,500,500,500,500,500,500,208,500,500,500,500,500,500,500,500,500],
		[500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500],
		[500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500],
		[500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500],
		[500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500],
		[500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500],
		[500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500],
		[500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500],
		[500,500,500,500,500,537,538,510,500,500,500,500,500,500,500,500,500,500,500,500],
		[500,500,500,500,500,535,521,549,535,521,500,500,500,500,500,500,500,500,500,500],
		[500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500],
		[500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500],
		[500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500],
		[500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500],
		[500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500],
		[500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500],
		[500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500],
		[500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500]
	],
};

let collisions = [
	[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
	[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
	[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
	[100,100,101,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
	[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
	[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
	[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
	[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
	[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
	[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
	[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
	[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
	[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
	[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
	[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
	[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
	[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
	[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
	[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
	[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100]
]

class World {
	constructor(element, width, height, cellWidth, cellHeight) {
		this.width = width;
		this.height = height;
		this._element = document.querySelector(element);
		this._objects = [];
		this._map = null;
		this._cellWidth = cellWidth;
		this._cellHeight = cellHeight;
		this._createMap();
		this._fillMap();
		this._init();
	}

	on(event, handler) {
		this._map.addEventListener(event, handler);
	}

	addObject(object) {
		this._objects.push(object);
	}

	spawnObjects() {
		for(let i = 0; i < this._objects.length; i++) {
			let object = this._objects[i];

			switch(object.getAttribute("type")) {
				case "player":
					if(object.getAttribute("name") === login.value) { // fix login - input, global var
						this._element.appendChild(object);
					} else {
						this._map.appendChild(object)
					}

					break;
				case "npc":
					this._map.appendChild(object)

					break;
			}
		}
	}

	exists(value) {
		let values = [];

		for(let i = 0; i < this._objects.length; i++) {
			values.push(this._objects[i].getAttribute("login"));
		}

		return values.includes(value);
	}

	onServer(data) {
		let decryptPacket = new Packet(data).decrypt();

		switch(decryptPacket.type) {
			case "playersInfo":
				decryptPacket.data.forEach(data => {
					if(!this.exists(data.login)) {
						if(data.login === login.value) { // fix login - input, global var
							this.addObject(player.create());
							players.add(player);
							player.setPosition(this.width / 2 - player.getWidth() / 2, this.height / 2 - player.getHeight() / 2);
						} else {
							let anotherPlayer = new Player(data.login);

							this.addObject(anotherPlayer.create());
							players.add(anotherPlayer);
						}
					}
				})

				this.spawnObjects();

				break;
			case "playerMove":
				let x = decryptPacket.data.x;
				let y = decryptPacket.data.y;
				let logins = {
					data: decryptPacket.data.login,
					current: login.value // fix
				}

				player.move(x, y, logins);
				
				break;
			case "npcList":
				decryptPacket.data.forEach(data => {
					let npc = new Npc(data);

					npcList.add(npc);
					this.addObject(npc.create());
				})

				this.spawnObjects();

				break;
			case "npcMove":
				let objectId = decryptPacket.data.objectId;
				let npc = npcList.getNpcByObjectId(objectId);

				if(npc) {
					npc.move(decryptPacket.data.x, decryptPacket.data.y)
				}

				break;
		}
	}

	_getPath(x1, y1, x2, y2) {
		let path = [];
		//this._drawPath(x1, y1, x2, y2, handler.bind(this));
		this._drawPath(x1+25, y1-25, x2+25, y2-25, handler.bind(this));
		this._drawPath(x1+25, y1+25, x2+25, y2+25, handler.bind(this));
		this._drawPath(x1-25, y1-25, x2-25, y2-25, handler.bind(this));
		this._drawPath(x1-25, y1+25, x2-25, y2+25, handler.bind(this));

		//
		let collisionEl = document.querySelector(".collisions");
		//

		function handler(x, y) {
			let cell = this._getCellIndex(x, y);
			let included = false;

			for(let i = 0; i < path.length; i++) {
				if(path[i].index.x === cell.index.x && path[i].index.y === cell.index.y) {
					included = true;
				}
			}

			if(!included && cell.index.x >= 0 && cell.index.y >= 0) {
				cell.coordinates = {
					x: x,
					y: y
				};
				path.push(cell);
			}
		}
		//
		for(let j = 0; j < collisionEl.children.length; j++) {
			collisionEl.children[j].style.background = "none";
		}

		for(let i = 0; i < path.length; i++) {
			let x = path[i].index.x;
			let y = path[i].index.y;

			if(collisionEl.children[y * map.size.width + x]) {	
				collisionEl.children[y * map.size.width + x].style.background = "red";
			}

		}
		//

		return path;
	}

	_drawPath(x1, y1, x2, y2, callback) {
		let deltaX = Math.abs(x2 - x1);
		let deltaY = Math.abs(y2 - y1);
		let signX = x1 < x2 ? 1 : -1;
		let signY = y1 < y2 ? 1 : -1;
		let error = deltaX - deltaY;

		while(x1 != x2 || y1 != y2) {
			let error2 = error * 2;

			if(error2 > -deltaY) {
				error -= deltaY;
				x1 += signX;
			}

			if(error2 < deltaX) {
				error += deltaX;
				y1 += signY;
			}

			callback(x1, y1);
		}
	}
	

	_getCellIndex(x, y) {
		return { 
			index: { 
				x: Math.floor(x / 50), 
				y: Math.floor(y / 50) 
			}
		};
	}

	_moveMap(e) {
		let x = e.detail.x;
		let y = e.detail.y;
			
		this._map.style.left = -(x - this.width / 2) + "px";
		this._map.style.top = -(y - this.height / 2) + "px";
	}

	_createMap() {
		this._map = document.createElement("div");
		this._map.classList.add("map");
		this._map.style.width = map.size.width * this._cellWidth + "px";
		this._map.style.height = map.size.height * this._cellHeight + "px";
		this._element.appendChild(this._map);
		window.addEventListener("moveMap", this._moveMap.bind(this));
	}

	_createCell() {
		let cell = document.createElement("div");

		cell.classList.add("cell");

		return cell;
	}

	_createField(type) {
		let field = document.createElement("div");
		
		field.classList.add(type);

		return field;
	}

	_fillMap() {
		for(let type in map) {
			if(type === "size") continue;

			let field = this._createField(type);

			for(let i = 0; i < map[type].length; i++) {
				for(let j = 0; j < map[type][i].length; j++) {
					let cell = this._createCell();

					if(map[type][i][j] >= 100 && map[type][i][j] <= 199) {
						cell.classList.add(`surface-${map[type][i][j]}`);
					}

					if(map[type][i][j] >= 200 && map[type][i][j] <= 299) {
						cell.classList.add(`tree-${map[type][i][j]}`);
					}

					if(map[type][i][j] >= 300 && map[type][i][j] <= 399) {
						cell.classList.add(`building-${map[type][i][j]}`);
					}

					if(map[type][i][j] >= 400 && map[type][i][j] <= 499) {
						cell.classList.add(`roof-${map[type][i][j]}`);
					}

					if(map[type][i][j] >= 500 && map[type][i][j] <= 599) {
						cell.classList.add(`misc-${map[type][i][j]}`);
					}

					field.appendChild(cell);	
				}

			}
			
			this._map.appendChild(field);

		}
			// for test
			// let field = this._createField("collisions");

			// for(let i = 0; i < collisions.length; i++) {
			// 	for(let j = 0; j < collisions[i].length; j++) {
			// 		let cell = this._createCell();

			// 		cell.classList.add(`collision-${collisions[i][j]}`);
			// 		field.appendChild(cell);
			// 	}
			// }

			// this._map.appendChild(field)
			//
	}

	_init() {
		this._element.style.width = this.width + "px";
		this._element.style.height = this.height + "px";
	}

}