<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="css/main.css">
	<title>Pacman mmorpg</title>
</head>
<body>

<div class="world"></div>

<script src="js/socket.io.js"></script>
<script src="js/World.js"></script>
<script src="js/Packet.js"></script>
<script src="js/Player.js"></script>
<script src="js/Players.js"></script>
<script>
	var world = new World(".world", 500, 400, 50, 50);
	var socket = new io("http://127.0.0.1:7777");
	var players = new Players();
	var login = "pacman";
	var player = new Player(login);

	world.on("click", coordinateHandler);
	socket.on("server", socketHandler);
	player.on("playerStartMove", function(directions) {
		var character = this.getCharacter();

		character.classList.add("player--walk");
		directions.detail.forEach(direction => character.classList.add("player--walk-" + direction));

	})
	player.on("playerStopMove", function(directions) {
		var character = this.getCharacter();

		character.classList.remove("player--walk");
		directions.detail.forEach(direction => character.classList.remove("player--walk-" + direction))
	})

	init();

	function coordinateHandler(data) {
		var data = { 
			type: "requestMove",
			data: {
				login: login,
				x: data.offsetX, 
				y: data.offsetY
			}
		}

		socket.emit("client", new Packet(data).send())
	}

	function socketHandler(data) {
		var packet = new Packet(data).receive();

		switch(packet.type) {
			case "playersInfo":
				packet.data.forEach(data => {
					if(!world.exists(data.login)) {
						if(data.login === login) {
							world.addPlayer(player.create());
							players.add(player);
							player.setPosition(world.width / 2 - player.width / 2, world.height / 2 - player.height / 2);
						} else {
							var anotherPlayer = new Player(data.login);

							world.addPlayer(anotherPlayer.create());
							players.add(anotherPlayer);
						}
					}
				})

				world.placeObjects(login);

				break;
			case "move":
				players.getPlayers().forEach((player, index) => {
					var x = packet.data[index].x;
					var y = packet.data[index].y;
					var logins = {
						data: packet.data[index].login,
						current: login
					}

					player.move(x, y, logins);
				})
				break;
		}
	}

	function init() {
		var data = {
			type: "requestAuth",
			data: {
				login: login,
				x: 0,
				y: 0
			}
		}
		socket.emit("client", new Packet(data).send());
	}

</script>

</body>
</html>