<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Pacman mmorpg</title>
</head>
<body>
	
<style>
	.world {
		width: 500px;
		height: 400px;
		border: 1px solid black;
		box-sizing: border-box;
		margin: 50px auto;
		position: relative;
	}

	.player {
		position: absolute;
	}

	.pacman {
		background: red;
	}

	.test {
		background: blue;
	}
</style>

<div class="world"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
<script>
	class World {
		constructor(element) {
			this._element = document.querySelector(element);
			this._objects = [];
		}

		on(event, handler) {
			this._element.addEventListener(event, handler);
		}

		addPlayer(player) {
			this._objects.push(player);
		}

		placeObjects() {
			for(var i = 0; i < this._objects.length; i++) {
				this._element.appendChild(this._objects[i]);
			}
		}

		exists(value) {
			var values = [];

			for(var i = 0; i < this._objects.length; i++) {
				values.push(this._objects[i].getAttribute("nickname"));
			}

			return values.includes(value);
		}

	}

	class Packet {
		constructor(data) {
			this._data = data;
		}

		send() {
			return JSON.stringify(this._data)
		}

		receive() {
			return JSON.parse(this._data);
		}
	}

	class Player {
		constructor(name, width = 50, height = 50) {
			this._name = name;
			this._width = width;
			this._height = height;
			this._x = 0;
			this._y = 0;
			this._timer = null;
		}

		create() {
			this._player = document.createElement("div");
			this._player.classList.add("player");
			this._player.classList.add(this._name);
			this._player.style.width = this._width + "px";
			this._player.style.height = this._height + "px";
			this._player.setAttribute("nickname", this._name);

			return this._player;
		}

		move(x, y) {
			clearInterval(this._timer);
			this._drawLine(this._x, this._y, x, y, handler.bind(this));

			function handler(x, y) {
				this._player.style.left = (x - this._width / 2) + "px";
				this._player.style.top = (y - this._height / 2) + "px";
				this._x = x;
				this._y = y;
			}
		}

		_drawLine(x1, y1, x2, y2, callback) {
		    var deltaX = Math.abs(x2 - x1);
		    var deltaY = Math.abs(y2 - y1);
		    var signX = x1 < x2 ? 1 : -1;
		    var signY = y1 < y2 ? 1 : -1;
		    var error = deltaX - deltaY;
		   	this._timer = setInterval(tick, 10);

		   	function tick() {
		   		if(x1 != x2 || y1 != y2) {
			        var error2 = error * 2;
			        
			        if(error2 > -deltaY) {
			            error -= deltaY;
			            x1 += signX;
			        }
			        
			        if(error2 < deltaX) {
			            error += deltaX;
			            y1 += signY;
			        }

			        callback(x1, y1);
		    	}
		   	}
		}
	}

	class Players {
		constructor() {
			this._players = [];
		}

		add(player) {
			this._players.push(player);
		}

		getPlayers() {
			return this._players;
		}
	}

	var world = new World(".world");
	var socket = new io("http://127.0.0.1:7777");
	var players = new Players();
	var login = "pacman";
	var player;

	world.on("click", coordinateHandler)
	socket.on("server", socketHandler);

	init();

	function coordinateHandler(data) {
		var data = { 
			type: "requestMove",
			data: {
				login: login,
				x: data.offsetX, 
				y: data.offsetY
			}
		}

		socket.emit("client", new Packet(data).send())
	}

	function socketHandler(data) {
		var packet = new Packet(data).receive();

		switch(packet.type) {
			case "playersInfo":
				packet.data.forEach(data => {
					if(!world.exists(data.login)) {
						if(data.login === login) {
							player = new Player(data.login);
							world.addPlayer(player.create());
							players.add(player);
						} else {
							var anotherPlayer = new Player(data.login);

							world.addPlayer(anotherPlayer.create());
							players.add(anotherPlayer);
						}
					}
				})

				world.placeObjects();

				break;
			case "move":
				players.getPlayers().forEach((player, index) => {
					var x = packet.data[index].x;
					var y = packet.data[index].y;

					player.move(x, y);
				})
				break;
		}
	}

	function init() {
		var data = {
			type: "requestAuth",
			data: {
				login: login,
				x: 0,
				y: 0
			}
		}
		socket.emit("client", new Packet(data).send());
	}

</script>

</body>
</html>